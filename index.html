<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üáØüáµ Japan 2025 Expense Tracker</title>
    <style>
        /* [STYLES REMAIN EXACTLY THE SAME AS YOUR ORIGINAL] */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 0; }
        .container { max-width: 100%; margin: 0 auto; background: white; min-height: 100vh; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 16px; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header h1 { font-size: 1.5em; margin-bottom: 8px; }
        .header p { opacity: 0.9; font-size: 0.9em; }
        .sync-status { background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px; display: inline-flex; align-items: center; gap: 6px; margin-top: 8px; font-size: 12px; }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: #4ade80; animation: pulse 2s infinite; }
        .sync-dot.disconnected { background: #ef4444; animation: none; }
        .sync-dot.connecting { background: #fbbf24; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .tabs { display: flex; background: white; border-bottom: 2px solid #e0e0e0; overflow-x: auto; position: sticky; top: 136px; z-index: 99; -webkit-overflow-scrolling: touch; }
        .tab { flex: 1; min-width: 90px; padding: 16px 8px; text-align: center; cursor: pointer; font-weight: 600; color: #666; transition: all 0.3s; border: none; background: none; font-size: 14px; white-space: nowrap; }
        .tab.active { color: #667eea; background: #f8f9fa; border-bottom: 3px solid #667eea; }
        .tab-content { display: none; padding: 16px; }
        .tab-content.active { display: block; }
        .form-section { background: #f8f9fa; padding: 16px; border-radius: 12px; margin-bottom: 16px; }
        .form-section h2 { font-size: 1.2em; margin-bottom: 16px; color: #333; }
        .form-row { display: flex; flex-direction: column; gap: 12px; margin-bottom: 12px; }
        .form-group { display: flex; flex-direction: column; }
        label { font-weight: 600; margin-bottom: 6px; color: #333; font-size: 14px; }
        input, select, textarea { padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; transition: border 0.3s; -webkit-appearance: none; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; }
        .split-checkboxes { display: flex; flex-direction: column; gap: 12px; margin-top: 8px; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; padding: 8px 0; }
        .checkbox-group input[type="checkbox"] { width: 24px; height: 24px; cursor: pointer; flex-shrink: 0; -webkit-appearance: none; -moz-appearance: none; appearance: none; border: 2px solid #667eea; border-radius: 4px; background: white; position: relative; }
        .checkbox-group input[type="checkbox"]:checked { background: #667eea; }
        .checkbox-group input[type="checkbox"]:checked::after { content: '‚úì'; position: absolute; color: white; font-size: 18px; font-weight: bold; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .checkbox-group label { flex: 1; font-size: 15px; color: #333; cursor: pointer; }
        .btn { padding: 14px 24px; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 16px; width: 100%; margin-top: 8px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
        .btn-primary:active { transform: scale(0.98); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; padding: 12px 20px; font-size: 14px; }
        .btn-danger { background: #dc3545; color: white; padding: 10px 16px; font-size: 13px; }
        .expense-card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #667eea; }
        .expense-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; }
        .expense-description { font-weight: 600; font-size: 16px; color: #333; margin-bottom: 4px; }
        .expense-category { font-size: 13px; color: #666; display: inline-block; background: #f8f9fa; padding: 4px 10px; border-radius: 12px; }
        .expense-amount { font-size: 20px; font-weight: 700; color: #667eea; text-align: right; }
        .expense-details { display: flex; flex-direction: column; gap: 8px; padding-top: 12px; border-top: 1px solid #e0e0e0; font-size: 14px; color: #666; }
        .summary-cards { display: flex; flex-direction: column; gap: 16px; margin-bottom: 16px; }
        .summary-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .summary-card h3 { color: #667eea; margin-bottom: 16px; font-size: 1.2em; }
        .summary-big-number { font-size: 2.5em; font-weight: 700; color: #667eea; }
        .person-summary { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid #e0e0e0; }
        .person-summary:last-child { border-bottom: none; }
        .amount-positive { color: #28a745; font-weight: 700; font-size: 15px; }
        .amount-negative { color: #dc3545; font-weight: 700; font-size: 15px; }
        .settlement-item { background: white; padding: 16px; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #667eea; }
        .settlement-amount { font-size: 28px; color: #667eea; font-weight: 700; }
        .alert { padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; }
        .alert-success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .alert-warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
        .alert-danger { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        .names-grid { display: flex; flex-direction: column; gap: 12px; margin-top: 12px; }
        
        @media (min-width: 768px) {
            .container { max-width: 1200px; border-radius: 16px; margin: 20px auto; min-height: calc(100vh - 40px); }
            .header { border-radius: 16px 16px 0 0; padding: 30px; }
            .header h1 { font-size: 2em; }
            .tabs { position: static; }
            .tab { min-width: 120px; padding: 20px; font-size: 16px; }
            .tab-content { padding: 30px; }
            .form-row { flex-direction: row; flex-wrap: wrap; }
            .form-row .form-group { flex: 1; min-width: 200px; }
            .split-checkboxes { flex-direction: row; flex-wrap: wrap; }
            .checkbox-group { flex: 0 0 calc(33.333% - 8px); }
            .summary-cards { flex-direction: row; }
            .summary-card { flex: 1; }
            .button-group { flex-direction: row; flex-wrap: wrap; }
            .names-grid { flex-direction: row; flex-wrap: wrap; }
            .names-grid .form-group { flex: 0 0 calc(33.333% - 8px); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="trip-name-display">üåç Expense Tracker</h1>
            <p>Real-time collaborative tracking</p>
            <div class="sync-status">
                <div class="sync-dot connecting" id="sync-dot"></div>
                <span id="sync-text">Connecting...</span>
            </div>
        </div>
        
        <div class="tabs" id="tabs-container"></div>
        
        <div id="expenses-tab" class="tab-content active">
            <div id="connection-alert"></div>
            
            <div class="form-section">
                <h2>Add Expense</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="expense-date" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="expense-description" placeholder="e.g., Hotel Night 1" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Category</label>
                        <select id="expense-category">
                            <option value="Lodging">üè® Lodging</option>
                            <option value="Food">üçΩÔ∏è Food</option>
                            <option value="Transport">üöó Transport</option>
                            <option value="Activities">üéâ Activities</option>
                            <option value="Shopping">üõçÔ∏è Shopping</option>
                            <option value="Other">üì¶ Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount (‚Ç±)</label>
                        <input type="number" id="expense-amount" step="0.01" placeholder="0.00" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Paid By</label>
                    <select id="expense-paidby"></select>
                </div>
                <div class="form-group">
                    <label>Split Between</label>
                    <div class="split-checkboxes" id="split-checkboxes"></div>
                </div>
                <button class="btn btn-primary" id="add-expense-btn">‚ûï Add Expense</button>
            </div>
            
            <div id="expenses-list"></div>
        </div>
        
        <div id="settlements-tab" class="tab-content">
            <div class="summary-card">
                <h3>üí∏ Pending Settlements</h3>
                <p style="color: #666; margin-bottom: 16px; font-size: 14px;">Who owes who?</p>
                <div id="settlement-plan"></div>
            </div>
        </div>
        
        <div id="summary-tab" class="tab-content">
            <div class="summary-cards">
                <div class="summary-card">
                    <h3>üíµ Total Spent</h3>
                    <div class="summary-big-number" id="total-spent">‚Ç±0.00</div>
                </div>
                <div class="summary-card">
                    <h3>üë• Per Person</h3>
                    <div class="summary-big-number" style="color: #764ba2;" id="per-person-avg">‚Ç±0.00</div>
                </div>
            </div>
            <div class="summary-card">
                <h3>Individual Balances</h3>
                <div id="individual-balances"></div>
            </div>
            <div class="export-section">
                <h3>üì• Actions</h3>
                <div class="button-group">
                    <button class="btn btn-danger" id="reset-data-btn">Reset All Data</button>
                </div>
            </div>
        </div>
        
        <div id="settings-tab" class="tab-content">
            <div class="summary-card">
                <h3>üè∑Ô∏è Trip Name</h3>
                <div class="form-group">
                    <label>Trip Name</label>
                    <input type="text" id="trip-name-input" placeholder="e.g., üáØüáµ Japan 2025">
                </div>
                <button class="btn btn-primary" id="save-trip-name-btn">üíæ Save Trip Name</button>
            </div>
            <div class="summary-card" style="margin-top: 16px;">
                <h3>üë• Traveler Names</h3>
                <div class="names-grid" id="names-grid"></div>
                <button class="btn btn-primary" id="save-names-btn">üíæ Save Names</button>
                <button class="btn btn-secondary" id="add-traveler-btn">‚ûï Add Traveler</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-database-compat.js"></script>

    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyCaZ2OKmF3tC1EQrFKHdfrdd3tJ82oxJCg",
            authDomain: "traveltrack-4c214.firebaseapp.com",
            databaseURL: "https://traveltrack-4c214-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "traveltrack-4c214",
            storageBucket: "traveltrack-4c214.firebasestorage.app",
            messagingSenderId: "106596988949",
            appId: "1:106596988949:web:a8c227cea905be15c3361c"
        };
        
        var database;
        var app = {
            expenses: [],
            people: ['Traveler 1', 'Traveler 2', 'Traveler 3'],
            tripName: 'üåç Expense Tracker',
            isConnected: false,
            
            init: function() {
                try {
                    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                    database = firebase.database();
                    this.setupDOM();
                    this.setupEventListeners();
                    this.setupFirebaseListeners();
                } catch(e) { console.error(e); this.showConnectionAlert('danger'); }
            },

            setupFirebaseListeners: function() {
                var self = this;
                database.ref('.info/connected').on('value', function(snap) {
                    self.isConnected = snap.val() === true;
                    self.updateSyncStatus(self.isConnected ? '‚úÖ Connected' : '‚ö†Ô∏è Reconnecting', self.isConnected);
                    if(self.isConnected) self.showConnectionAlert('success');
                });

                database.ref('expenses').on('value', function(snap) {
                    self.expenses = snap.val() ? Object.values(snap.val()) : [];
                    self.renderExpenses();
                    self.calculateSettlements();
                });

                database.ref('people').on('value', function(snap) {
                    if(snap.val()) {
                        self.people = snap.val();
                        self.renderNameInputs();
                        self.populateDropdowns();
                    }
                });
                
                database.ref('tripName').on('value', function(snap) {
                    if(snap.val()) {
                        self.tripName = snap.val();
                        document.getElementById('trip-name-display').textContent = self.tripName;
                        document.getElementById('trip-name-input').value = self.tripName;
                    }
                });
            },

            setupDOM: function() {
                document.getElementById('expense-date').valueAsDate = new Date();
                this.renderTabs();
                this.renderNameInputs();
                this.populateDropdowns();
            },

            renderTabs: function() {
                var tabs = [
                    { id: 'expenses', label: 'üí∞ Expenses' },
                    { id: 'settlements', label: 'ü§ù Settle' },
                    { id: 'summary', label: 'üìä Summary' },
                    { id: 'settings', label: '‚öôÔ∏è Settings' }
                ];
                document.getElementById('tabs-container').innerHTML = tabs.map((tab, i) => 
                    `<button class="tab ${i === 0 ? 'active' : ''}" data-tab="${tab.id}">${tab.label}</button>`
                ).join('');
            },

            switchTab: function(tabId) {
                document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tabId));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === tabId + '-tab'));
            },

            setupEventListeners: function() {
                var self = this;
                document.getElementById('tabs-container').addEventListener('click', e => {
                    if(e.target.classList.contains('tab')) self.switchTab(e.target.dataset.tab);
                });
                document.getElementById('add-expense-btn').onclick = () => self.addExpense();
                document.getElementById('save-names-btn').onclick = () => self.saveNames();
                document.getElementById('add-traveler-btn').onclick = () => self.addTraveler();
                document.getElementById('save-trip-name-btn').onclick = () => {
                    var name = document.getElementById('trip-name-input').value;
                    database.ref('tripName').set(name);
                };
                document.getElementById('reset-data-btn').onclick = () => {
                    if(confirm('Are you sure? This deletes ALL data.')) database.ref().remove();
                };
            },

            populateDropdowns: function() {
                var payerSelect = document.getElementById('expense-paidby');
                var checkboxesDiv = document.getElementById('split-checkboxes');
                var currentPayer = payerSelect.value;
                
                payerSelect.innerHTML = this.people.map(p => `<option value="${p}">${p}</option>`).join('');
                if(currentPayer && this.people.includes(currentPayer)) payerSelect.value = currentPayer;

                checkboxesDiv.innerHTML = this.people.map((p, i) => `
                    <div class="checkbox-group">
                        <input type="checkbox" id="split-${i}" value="${p}" checked>
                        <label for="split-${i}">${p}</label>
                    </div>
                `).join('');
            },

            renderNameInputs: function() {
                var grid = document.getElementById('names-grid');
                grid.innerHTML = this.people.map((person, i) => 
                    `<div class="form-group"><label>Traveler ${i + 1}</label><input type="text" id="name-${i}" value="${person}"></div>`
                ).join('');
            },

            saveNames: function() {
                var newNames = [];
                for(var i = 0; i < this.people.length; i++) {
                    var val = document.getElementById('name-' + i).value;
                    if(val) newNames.push(val);
                }
                database.ref('people').set(newNames);
            },

            addTraveler: function() {
                this.people.push('Traveler ' + (this.people.length + 1));
                this.saveNames(); // This triggers Firebase update which triggers render
            },

            addExpense: function() {
                var desc = document.getElementById('expense-description').value;
                var amt = parseFloat(document.getElementById('expense-amount').value);
                var payer = document.getElementById('expense-paidby').value;
                var date = document.getElementById('expense-date').value;
                var category = document.getElementById('expense-category').value;
                
                if (!desc || isNaN(amt)) return alert('Please enter description and amount');

                var involved = [];
                this.people.forEach((p, i) => {
                    if(document.getElementById('split-' + i).checked) involved.push(p);
                });

                if(involved.length === 0) return alert('Select at least one person to split with');

                var expense = {
                    id: Date.now(),
                    date: date,
                    description: desc,
                    category: category,
                    amount: amt,
                    paidBy: payer,
                    splitAmong: involved,
                    timestamp: Date.now()
                };

                database.ref('expenses/' + expense.id).set(expense);
                
                // Clear inputs
                document.getElementById('expense-description').value = '';
                document.getElementById('expense-amount').value = '';
            },

            renderExpenses: function() {
                var list = document.getElementById('expenses-list');
                list.innerHTML = this.expenses.sort((a,b) => b.timestamp - a.timestamp).map(ex => `
                    <div class="expense-card">
                        <div class="expense-header">
                            <div>
                                <div class="expense-description">${ex.description}</div>
                                <div class="expense-category">${ex.category}</div>
                            </div>
                            <div class="expense-amount">‚Ç±${parseFloat(ex.amount).toFixed(2)}</div>
                        </div>
                        <div class="expense-details">
                            <div>Paid by: <strong>${ex.paidBy}</strong></div>
                            <div>Split: ${ex.splitAmong.join(', ')}</div>
                            <button onclick="deleteExpense(${ex.id})" class="btn-danger" style="width:auto; float:right;">Delete</button>
                        </div>
                    </div>
                `).join('');
            },

            calculateSettlements: function() {
                var balances = {};
                this.people.forEach(p => balances[p] = 0);
                var total = 0;

                this.expenses.forEach(ex => {
                    total += parseFloat(ex.amount);
                    balances[ex.paidBy] += parseFloat(ex.amount);
                    var splitAmt = ex.amount / ex.splitAmong.length;
                    ex.splitAmong.forEach(person => {
                        if(balances[person] !== undefined) balances[person] -= splitAmt;
                    });
                });

                document.getElementById('total-spent').innerText = '‚Ç±' + total.toFixed(2);
                document.getElementById('per-person-avg').innerText = '‚Ç±' + (this.people.length ? (total/this.people.length).toFixed(2) : '0.00');

                var balHtml = '';
                for(var p in balances) {
                    var amt = balances[p];
                    var colorClass = amt > 0 ? 'amount-positive' : (amt < 0 ? 'amount-negative' : 'amount-neutral');
                    balHtml += `<div class="person-summary">
                        <span class="person-name">${p}</span>
                        <span class="${colorClass}">${amt > 0 ? '+' : ''}‚Ç±${amt.toFixed(2)}</span>
                    </div>`;
                }
                document.getElementById('individual-balances').innerHTML = balHtml;
                
                // Simple settlement Algorithm
                var debtors = [], creditors = [];
                for(const [p, amt] of Object.entries(balances)) {
                    if(amt < -0.01) debtors.push({p, amt});
                    if(amt > 0.01) creditors.push({p, amt});
                }
                debtors.sort((a,b) => a.amt - b.amt);
                creditors.sort((a,b) => b.amt - a.amt);

                var settlements = [];
                var i=0, j=0;
                while(i < debtors.length && j < creditors.length) {
                    var debtor = debtors[i], creditor = creditors[j];
                    var amt = Math.min(Math.abs(debtor.amt), creditor.amt);
                    settlements.push(`${debtor.p} owes ${creditor.p} <strong>‚Ç±${amt.toFixed(2)}</strong>`);
                    debtor.amt += amt;
                    creditor.amt -= amt;
                    if(Math.abs(debtor.amt) < 0.01) i++;
                    if(creditor.amt < 0.01) j++;
                }
                
                document.getElementById('settlement-plan').innerHTML = settlements.length ? 
                    settlements.map(s => `<div class="settlement-item" style="font-size:16px;">${s}</div>`).join('') : 
                    '<div class="alert alert-success">All settled up!</div>';
            },

            updateSyncStatus: function(text, connected) {
                var dot = document.getElementById('sync-dot');
                var span = document.getElementById('sync-text');
                dot.className = 'sync-dot ' + (connected ? '' : 'disconnected');
                span.textContent = text;
            },

            showConnectionAlert: function(type) {
                var div = document.getElementById('connection-alert');
                div.className = 'alert alert-' + type;
                div.innerHTML = type === 'success' ? '‚úÖ <strong>Live Sync Active</strong>' : '‚ö†Ô∏è <strong>Connection Issues</strong>';
            }
        };

        // Global function for the delete button
        window.deleteExpense = function(id) {
            if(confirm('Delete this expense?')) database.ref('expenses/' + id).remove();
        };

        // Start App
        document.addEventListener('DOMContentLoaded', function() { app.init(); });
    </script>
</body>
</html>