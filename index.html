<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üáØüáµ Japan 2025 Expense Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .sync-status {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
        }
        
        .sync-dot.disconnected {
            background: #ef4444;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
        }
        
        .tab {
            flex: 1;
            min-width: 120px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            border: none;
            background: none;
            font-size: 16px;
        }
        
        .tab:hover {
            background: #e9ecef;
        }
        
        .tab.active {
            color: #667eea;
            background: white;
            border-bottom: 3px solid #667eea;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
            font-size: 14px;
        }
        
        input, select, textarea {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .split-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .expense-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .expense-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }
        
        .expense-table td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
        }
        
        .expense-table tr:hover {
            background: #f8f9fa;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .summary-card h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3em;
        }
        
        .person-summary {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .person-summary:last-child {
            border-bottom: none;
        }
        
        .person-name {
            font-weight: 600;
            color: #333;
        }
        
        .amount-positive {
            color: #28a745;
            font-weight: 700;
        }
        
        .amount-negative {
            color: #dc3545;
            font-weight: 700;
        }
        
        .amount-neutral {
            color: #6c757d;
            font-weight: 600;
        }
        
        .settlement-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        
        .settlement-item.paid {
            background: #d4edda;
            border-left-color: #28a745;
            opacity: 0.7;
        }
        
        .settlement-info {
            flex: 1;
        }
        
        .settlement-amount {
            font-size: 1.5em;
            color: #667eea;
            margin-top: 5px;
        }
        
        .settlement-item.paid .settlement-amount {
            color: #28a745;
            text-decoration: line-through;
        }
        
        .settlement-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .paid-badge {
            background: #28a745;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .export-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .status-summary {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .status-item {
            flex: 1;
            text-align: center;
        }
        
        .status-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .status-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .names-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .split-checkboxes {
                grid-template-columns: 1fr;
            }
            
            .expense-table {
                font-size: 12px;
            }
            
            .expense-table th, .expense-table td {
                padding: 10px 5px;
            }
            
            .settlement-item {
                flex-direction: column;
                gap: 15px;
            }
            
            .settlement-actions {
                width: 100%;
                justify-content: center;
            }
            
            .status-summary {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üáØüáµ Japan 2025 Expense Tracker</h1>
            <p>Real-time collaborative expense tracking</p>
            <div class="sync-status">
                <div class="sync-dot" id="sync-dot"></div>
                <span id="sync-text">Connecting...</span>
            </div>
        </div>
        
        <div class="tabs" id="tabs-container"></div>
        
        <div id="expenses-tab" class="tab-content active">
            <div class="alert alert-success">
                <strong>üåê Live Collaboration Active!</strong> All changes sync automatically across all devices in real-time!
            </div>
            
            <div class="form-section">
                <h2 style="margin-bottom: 20px; color: #333;">Add New Expense</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="expense-date" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="expense-description" placeholder="e.g., Hotel - Night 1" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Category</label>
                        <select id="expense-category">
                            <option value="Lodging">üè® Lodging</option>
                            <option value="Food">üçΩÔ∏è Food</option>
                            <option value="Transport">üöó Transport</option>
                            <option value="Activities">üéâ Activities</option>
                            <option value="Shopping">üõçÔ∏è Shopping</option>
                            <option value="Other">üì¶ Other</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Total Amount (‚Ç± Peso)</label>
                        <input type="number" id="expense-amount" step="0.01" placeholder="0.00" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Paid By</label>
                        <select id="expense-paidby"></select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Split Between (Select all who should share this expense)</label>
                    <div class="split-checkboxes" id="split-checkboxes"></div>
                </div>
                
                <button class="btn btn-primary" id="add-expense-btn">‚ûï Add Expense</button>
            </div>
            
            <div id="expenses-list"></div>
        </div>
        
        <div id="summary-tab" class="tab-content">
            <div class="summary-cards">
                <div class="summary-card">
                    <h3>üíµ Total Spent</h3>
                    <h1 style="color: #667eea; font-size: 2.5em;" id="total-spent">‚Ç±0.00</h1>
                </div>
                
                <div class="summary-card">
                    <h3>üë• Per Person Average</h3>
                    <h1 style="color: #764ba2; font-size: 2.5em;" id="per-person-avg">‚Ç±0.00</h1>
                </div>
            </div>
            
            <div class="summary-card">
                <h3>Individual Balances</h3>
                <div id="individual-balances"></div>
            </div>
            
            <div class="summary-card" style="margin-top: 20px;">
                <h3>üìà Spending by Category</h3>
                <div id="category-breakdown"></div>
            </div>
        </div>
        
        <div id="settlements-tab" class="tab-content">
            <div class="summary-card">
                <h3>üí∏ Who Owes Whom</h3>
                <p style="color: #666; margin-bottom: 20px;">Simplified settlement plan (minimum transactions)</p>
                
                <div class="status-summary">
                    <div class="status-item">
                        <div class="status-number" id="total-payments">0</div>
                        <div class="status-label">Total Payments</div>
                    </div>
                    <div class="status-item">
                        <div class="status-number" style="color: #28a745;" id="paid-count">0</div>
                        <div class="status-label">Paid</div>
                    </div>
                    <div class="status-item">
                        <div class="status-number" style="color: #dc3545;" id="pending-count">0</div>
                        <div class="status-label">Pending</div>
                    </div>
                </div>
                
                <div id="settlement-plan"></div>
            </div>
            
            <div class="export-section">
                <h3 style="margin-bottom: 15px;">üì• Export Data</h3>
                <p style="color: #666; margin-bottom: 10px;">Download backup of your expense data</p>
                <div class="button-group">
                    <button class="btn btn-secondary" id="export-json-btn">üì§ Export JSON</button>
                    <button class="btn btn-secondary" id="export-csv-btn">Download CSV</button>
                    <button class="btn btn-secondary" id="copy-summary-btn">Copy Summary</button>
                    <button class="btn btn-danger" id="reset-data-btn">Reset All Data</button>
                </div>
            </div>
        </div>
        
        <div id="settings-tab" class="tab-content">
            <div class="summary-card">
                <h3>üë• Customize Traveler Names</h3>
                <p style="color: #666; margin-bottom: 20px;">Enter the names of all 7 travelers. Changes sync to everyone!</p>
                
                <div class="alert alert-warning" style="margin-bottom: 20px;">
                    <strong>‚ö†Ô∏è Important:</strong> Change names BEFORE adding expenses. Changing names later will not update existing expenses.
                </div>
                
                <div class="names-grid" id="names-grid"></div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" id="save-names-btn">üíæ Save Names</button>
                    <button class="btn btn-secondary" id="reset-names-btn">üîÑ Reset to Defaults</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        (function() {
            'use strict';
            
            // üî• FIREBASE CONFIGURATION
            const firebaseConfig = {
                apiKey: "AIzaSyCaZ2OKmF3tC1EQrFKHdfrdd3tJ82oxJCg",
                authDomain: "traveltrack-4c214.firebaseapp.com",
                databaseURL: "https://traveltrack-4c214-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "traveltrack-4c214",
                storageBucket: "traveltrack-4c214.firebasestorage.app",
                messagingSenderId: "106596988949",
                appId: "1:106596988949:web:a8c227cea905be15c3361c"
            };
            
            // Initialize Firebase
            let database;
            let isFirebaseConfigured = false;
            
            try {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                isFirebaseConfigured = true;
                console.log('‚úÖ Firebase connected successfully!');
            } catch (error) {
                console.error('‚ùå Firebase initialization error:', error);
                alert('Firebase connection failed. Using local storage fallback.');
            }
            
            const app = {
                expenses: [],
                payments: [],
                people: ['Person 1', 'Person 2', 'Person 3', 'Person 4', 'Person 5', 'Person 6', 'Person 7'],
                isLoading: false,
                
                init: function() {
                    try {
                        this.setupDOM();
                        this.setupEventListeners();
                        
                        if (isFirebaseConfigured) {
                            this.setupFirebaseListeners();
                        } else {
                            this.loadFromLocalStorage();
                            this.updateSyncStatus('Using Local Storage', false);
                        }
                    } catch (error) {
                        console.error('Init error:', error);
                        alert('Failed to initialize app: ' + error.message);
                    }
                },
                
                setupDOM: function() {
                    const dateInput = document.getElementById('expense-date');
                    if (dateInput) {
                        dateInput.valueAsDate = new Date();
                    }
                    
                    this.renderTabs();
                    this.renderNameInputs();
                },
                
                renderTabs: function() {
                    const tabsContainer = document.getElementById('tabs-container');
                    const tabs = [
                        { id: 'expenses', label: 'üí∞ Expenses' },
                        { id: 'summary', label: 'üìä Summary' },
                        { id: 'settlements', label: 'ü§ù Settlements' },
                        { id: 'settings', label: '‚öôÔ∏è Settings' }
                    ];
                    
                    tabsContainer.innerHTML = tabs.map((tab, index) => 
                        `<button class="tab ${index === 0 ? 'active' : ''}" data-tab="${tab.id}">${tab.label}</button>`
                    ).join('');
                },
                
                renderNameInputs: function() {
                    const namesGrid = document.getElementById('names-grid');
                    namesGrid.innerHTML = Array.from({ length: 7 }, (_, i) => `
                        <div class="form-group">
                            <label>Traveler ${i + 1}</label>
                            <input type="text" id="name-${i}" placeholder="Person ${i + 1}">
                        </div>
                    `).join('');
                },
                
                setupEventListeners: function() {
                    const self = this;
                    
                    document.getElementById('tabs-container').addEventListener('click', function(e) {
                        if (e.target.classList.contains('tab')) {
                            self.switchTab(e.target.dataset.tab);
                        }
                    });
                    
                    document.getElementById('add-expense-btn').addEventListener('click', () => this.addExpense());
                    document.getElementById('save-names-btn').addEventListener('click', () => this.saveNames());
                    document.getElementById('reset-names-btn').addEventListener('click', () => this.resetNames());
                    document.getElementById('export-json-btn').addEventListener('click', () => this.exportToJSON());
                    document.getElementById('export-csv-btn').addEventListener('click', () => this.exportToCSV());
                    document.getElementById('copy-summary-btn').addEventListener('click', () => this.copyToClipboard());
                    document.getElementById('reset-data-btn').addEventListener('click', () => this.resetAllData());
                },
                
                setupFirebaseListeners: function() {
                    const self = this;
                    
                    database.ref('expenses').on('value', (snapshot) => {
                        const data = snapshot.val();
                        self.expenses = data ? Object.values(data) : [];
                        self.renderExpenses();
                        self.updateSyncStatus('‚úÖ Synced', true);
                    });
                    
                    database.ref('payments').on('value', (snapshot) => {
                        const data = snapshot.val();
                        self.payments = data || [];
                    });
                    
                    database.ref('people').on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            self.people = data;
                            for (let i = 0; i < 7; i++) {
                                const input = document.getElementById(`name-${i}`);
                                if (input) input.value = self.people[i];
                            }
                            self.populateDropdowns();
                        }
                    });
                },
                
                loadFromLocalStorage: function() {
                    const savedExpenses = localStorage.getItem('japan-expenses');
                    const savedPayments = localStorage.getItem('japan-payments');
                    const savedPeople = localStorage.getItem('japan-people');
                    
                    if (savedExpenses) this.expenses = JSON.parse(savedExpenses);
                    if (savedPayments) this.payments = JSON.parse(savedPayments);
                    if (savedPeople) {
                        this.people = JSON.parse(savedPeople);
                        for (let i = 0; i < 7; i++) {
                            const input = document.getElementById(`name-${i}`);
                            if (input) input.value = this.people[i];
                        }
                    }
                    
                    this.populateDropdowns();
                    this.renderExpenses();
                },
                
                saveToFirebase: async function(path, data) {
                    if (isFirebaseConfigured) {
                        try {
                            await database.ref(path).set(data);
                            return true;
                        } catch (error) {
                            console.error('Firebase save error:', error);
                            alert('Failed to sync: ' + error.message);
                            return false;
                        }
                    } else {
                        localStorage.setItem('japan-' + path, JSON.stringify(data));
                        return true;
                    }
                },
                
                updateSyncStatus: function(text, connected) {
                    const elem = document.getElementById('sync-text');
                    const dot = document.getElementById('sync-dot');
                    if (elem) elem.textContent = text;
                    if (dot) {
                        if (connected) {
                            dot.classList.remove('disconnected');
                        } else {
                            dot.classList.add('disconnected');
                        }
                    }
                },
                
                switchTab: function(tabName) {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    const tabBtn = document.querySelector(`[data-tab="${tabName}"]`);
                    const tabContent = document.getElementById(tabName + '-tab');
                    
                    if (tabBtn) tabBtn.classList.add('active');
                    if (tabContent) tabContent.classList.add('active');
                    
                    if (tabName === 'summary') {
                        this.updateSummary();
                    } else if (tabName === 'settlements') {
                        this.calculateSettlements();
                    }
                },
                
                populateDropdowns: function() {
                    const paidBySelect = document.getElementById('expense-paidby');
                    const splitCheckboxes = document.getElementById('split-checkboxes');
                    
                    if (paidBySelect) {
                        paidBySelect.innerHTML = this.people.map(person => 
                            `<option value="${person}">${person}</option>`
                        ).join('');
                    }
                    
                    if (splitCheckboxes) {
                        splitCheckboxes.innerHTML = this.people.map((person, i) => `
                            <div class="checkbox-group">
                                <input type="checkbox" id="split-person${i}" checked>
                                <label for="split-person${i}">${person}</label>
                            </div>
                        `).join('');
                    }
                },
                
                updateNames: function() {
                    for (let i = 0; i < 7; i++) {
                        const input = document.getElementById(`name-${i}`);
                        if (input) {
                            const value = input.value.trim();
                            this.people[i] = value || `Person ${i + 1}`;
                        }
                    }
                },
                
                saveNames: async function() {
                    this.updateNames();
                    const success = await this.saveToFirebase('people', this.people);
                    if (success) {
                        alert('‚úì Names saved and synced!');
                        this.populateDropdowns();
                    }
                },
                
                resetNames: async function() {
                    if (confirm('Reset all names to default (Person 1, Person 2, etc.)?')) {
                        this.people = ['Person 1', 'Person 2', 'Person 3', 'Person 4', 'Person 5', 'Person 6', 'Person 7'];
                        for (let i = 0; i < 7; i++) {
                            const input = document.getElementById(`name-${i}`);
                            if (input) input.value = '';
                        }
                        await this.saveNames();
                    }
                },
                
                addExpense: async function() {
                    const btn = document.getElementById('add-expense-btn');
                    if (this.isLoading) return;
                    
                    const date = document.getElementById('expense-date').value;
                    const description = document.getElementById('expense-description').value;
                    const category = document.getElementById('expense-category').value;
                    const amount = parseFloat(document.getElementById('expense-amount').value);
                    const paidBy = document.getElementById('expense-paidby').value;
                    
                    if (!date || !description || !amount || amount <= 0) {
                        alert('Please fill in all required fields with valid values');
                        return;
                    }
                    
                    const splitBetween = [];
                    for (let i = 0; i < 7; i++) {
                        const checkbox = document.getElementById(`split-person${i}`);
                        if (checkbox && checkbox.checked) {
                            splitBetween.push(this.people[i]);
                        }
                    }
                    
                    if (splitBetween.length === 0) {
                        alert('Please select at least one person to split the expense');
                        return;
                    }
                    
                    this.isLoading = true;
                    btn.disabled = true;
                    btn.textContent = 'Saving...';
                    
                    const expense = {
                        id: Date.now(),
                        date,
                        description,
                        category,
                        amount,
                        paidBy,
                        splitBetween
                    };
                    
                    this.expenses.push(expense);
                    
                    if (isFirebaseConfigured) {
                        const expensesObj = {};
                        this.expenses.forEach(exp => {
                            expensesObj[exp.id] = exp;
                        });
                        await this.saveToFirebase('expenses', expensesObj);
                    } else {
                        await this.saveToFirebase('expenses', this.expenses);
                        this.renderExpenses();
                    }
                    
                    this.clearForm();
                    
                    this.isLoading = false;
                    btn.disabled = false;
                    btn.textContent = '‚ûï Add Expense';
                },
                
                clearForm: function() {
                    document.getElementById('expense-description').value = '';
                    document.getElementById('expense-amount').value = '';
                    for (let i = 0; i < 7; i++) {
                        const checkbox = document.getElementById(`split-person${i}`);
                        if (checkbox) checkbox.checked = true;
                    }
                },
                
                deleteExpense: async function(id) {
                    if (!confirm('Are you sure you want to delete this expense?')) return;
                    
                    const index = this.expenses.findIndex(e => e.id === id);
                    if (index === -1) return;
                    
                    this.expenses.splice(index, 1);
                    
                    if (isFirebaseConfigured) {
                        await database.ref('expenses/' + id).remove();
                    } else {
                        await this.saveToFirebase('expenses', this.expenses);
                        this.renderExpenses();
                    }
                },
                
                renderExpenses: function() {
                    const container = document.getElementById('expenses-list');
                    if (!container) return;
                    
                    if (this.expenses.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <svg fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z"></path><path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd"></path></svg>
                                <h3>No expenses yet</h3>
                                <p>Add your first expense to get started</p>
                            </div>
                        `;
                        return;
                    }
                    
                    const self = this;
                    let html = '<table class="expense-table"><thead><tr>';
                    html += '<th>Date</th><th>Description</th><th>Category</th><th>Amount</th><th>Paid By</th><th>Split Between</th><th>Per Person</th><th>Action</th>';
                    html += '</tr></thead><tbody>';
                    
                    this.expenses.forEach(exp => {
                        const perPerson = exp.amount / exp.splitBetween.length;
                        html += `<tr>
                            <td>${exp.date}</td>
                            <td>${exp.description}</td>
                            <td>${exp.category}</td>
                            <td>‚Ç±${exp.amount.toFixed(2)}</td>
                            <td><strong>${exp.paidBy}</strong></td>
                            <td>${exp.splitBetween.join(', ')}</td>
                            <td>‚Ç±${perPerson.toFixed(2)}</td>
                            <td><button class="btn btn-danger" data-delete-id="${exp.id}">Delete</button></td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table>';
                    container.innerHTML = html;
                    
                    container.querySelectorAll('[data-delete-id]').forEach(btn => {
                        btn.addEventListener('click', function() {
                            self.deleteExpense(parseInt(this.dataset.deleteId));
                        });
                    });
                },
                
                markAsPaid: async function(settlementId) {
                    if (!this.payments.includes(settlementId)) {
                        this.payments.push(settlementId);
                        await this.saveToFirebase('payments', this.payments);
                        this.calculateSettlements();
                    }
                },
                
                markAsUnpaid: async function(settlementId) {
                    this.payments = this.payments.filter(id => id !== settlementId);
                    await this.saveToFirebase('payments', this.payments);
                    this.calculateSettlements();
                },
                
                updateSummary: function() {
                    const totalSpent = this.expenses.reduce((sum, exp) => sum + exp.amount, 0);
                    const avgPerPerson = totalSpent / 7;
                    
                    const totalSpentEl = document.getElementById('total-spent');
                    const avgPerPersonEl = document.getElementById('per-person-avg');
                    if (totalSpentEl) totalSpentEl.textContent = `‚Ç±${totalSpent.toFixed(2)}`;
                    if (avgPerPersonEl) avgPerPersonEl.textContent = `‚Ç±${avgPerPerson.toFixed(2)}`;
                    
                    const balances = {};
                    this.people.forEach(person => {
                        balances[person] = { paid: 0, owes: 0 };
                    });
                    
                    this.expenses.forEach(exp => {
                        balances[exp.paidBy].paid += exp.amount;
                        const perPerson = exp.amount / exp.splitBetween.length;
                        exp.splitBetween.forEach(person => {
                            balances[person].owes += perPerson;
                        });
                    });
                    
                    let balanceHtml = '';
                    this.people.forEach(person => {
                        const net = balances[person].paid - balances[person].owes;
                        const amountClass = net > 0.01 ? 'amount-positive' : net < -0.01 ? 'amount-negative' : 'amount-neutral';
                        const status = net > 0.01 ? 'Gets back' : net < -0.01 ? 'Owes' : 'Settled';
                        
                        balanceHtml += `
                            <div class="person-summary">
                                <div>
                                    <div class="person-name">${person}</div>
                                    <div style="font-size: 12px; color: #666;">Paid: ‚Ç±${balances[person].paid.toFixed(2)} | Share: ‚Ç±${balances[person].owes.toFixed(2)}</div>
                                </div>
                                <div class="${amountClass}">
                                    ${status}: ‚Ç±${Math.abs(net).toFixed(2)}
                                </div>
                            </div>
                        `;
                    });
                    
                    const balancesContainer = document.getElementById('individual-balances');
                    if (balancesContainer) balancesContainer.innerHTML = balanceHtml;
                    
                    const categories = {};
                    this.expenses.forEach(exp => {
                        categories[exp.category] = (categories[exp.category] || 0) + exp.amount;
                    });
                    
                    let categoryHtml = '';
                    Object.entries(categories).forEach(([cat, amount]) => {
                        const percentage = (amount / totalSpent * 100).toFixed(1);
                        categoryHtml += `
                            <div class="person-summary">
                                <span>${cat}</span>
                                <span><strong>‚Ç±${amount.toFixed(2)}</strong> (${percentage}%)</span>
                            </div>
                        `;
                    });
                    
                    const categoryContainer = document.getElementById('category-breakdown');
                    if (categoryContainer) {
                        categoryContainer.innerHTML = categoryHtml || '<p style="color: #999;">No expenses yet</p>';
                    }
                },
                
                calculateSettlements: function() {
                    const balances = {};
                    this.people.forEach(person => {
                        balances[person] = 0;
                    });
                    
                    this.expenses.forEach(exp => {
                        balances[exp.paidBy] += exp.amount;
                        const perPerson = exp.amount / exp.splitBetween.length;
                        exp.splitBetween.forEach(person => {
                            balances[person] -= perPerson;
                        });
                    });
                    
                    const debtors = [];
                    const creditors = [];
                    
                    Object.entries(balances).forEach(([person, balance]) => {
                        if (balance < -0.01) {
                            debtors.push({ person, amount: -balance });
                        } else if (balance > 0.01) {
                            creditors.push({ person, amount: balance });
                        }
                    });
                    
                    const settlements = [];
                    let i = 0, j = 0;
                    
                    while (i < debtors.length && j < creditors.length) {
                        const amount = Math.min(debtors[i].amount, creditors[j].amount);
                        settlements.push({
                            id: `${debtors[i].person}-${creditors[j].person}`,
                            from: debtors[i].person,
                            to: creditors[j].person,
                            amount
                        });
                        
                        debtors[i].amount -= amount;
                        creditors[j].amount -= amount;
                        
                        if (debtors[i].amount < 0.01) i++;
                        if (creditors[j].amount < 0.01) j++;
                    }
                    
                    const totalPaymentsEl = document.getElementById('total-payments');
                    const paidCountEl = document.getElementById('paid-count');
                    const pendingCountEl = document.getElementById('pending-count');
                    
                    const paidCount = this.payments.length;
                    if (totalPaymentsEl) totalPaymentsEl.textContent = settlements.length;
                    if (paidCountEl) paidCountEl.textContent = paidCount;
                    if (pendingCountEl) pendingCountEl.textContent = settlements.length - paidCount;
                    
                    const self = this;
                    let html = '';
                    if (settlements.length === 0) {
                        html = '<p style="color: #999; text-align: center; padding: 40px;">All settled! No payments needed.</p>';
                    } else {
                        settlements.forEach(s => {
                            const isPaid = this.payments.includes(s.id);
                            html += `
                                <div class="settlement-item ${isPaid ? 'paid' : ''}">
                                    <div class="settlement-info">
                                        <div><strong>${s.from}</strong> pays <strong>${s.to}</strong></div>
                                        <div class="settlement-amount">‚Ç±${s.amount.toFixed(2)}</div>
                                    </div>
                                    <div class="settlement-actions">
                                        ${isPaid 
                                            ? `<span class="paid-badge">‚úì PAID</span>
                                               <button class="btn btn-secondary" data-unpay-id="${s.id}">Undo</button>`
                                            : `<button class="btn btn-success" data-pay-id="${s.id}">‚úì Mark as Paid</button>`
                                        }
                                    </div>
                                </div>
                            `;
                        });
                    }
                    
                    const planContainer = document.getElementById('settlement-plan');
                    if (planContainer) {
                        planContainer.innerHTML = html;
                        
                        planContainer.querySelectorAll('[data-pay-id]').forEach(btn => {
                            btn.addEventListener('click', function() {
                                self.markAsPaid(this.dataset.payId);
                            });
                        });
                        
                        planContainer.querySelectorAll('[data-unpay-id]').forEach(btn => {
                            btn.addEventListener('click', function() {
                                self.markAsUnpaid(this.dataset.unpayId);
                            });
                        });
                    }
                },
                
                resetAllData: async function() {
                    if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL expenses and payment data for EVERYONE! This cannot be undone. Are you sure?')) {
                        return;
                    }
                    
                    if (!confirm('Are you ABSOLUTELY sure? This affects all users!')) {
                        return;
                    }
                    
                    try {
                        if (isFirebaseConfigured) {
                            await database.ref('expenses').remove();
                            await database.ref('payments').remove();
                        } else {
                            localStorage.removeItem('japan-expenses');
                            localStorage.removeItem('japan-payments');
                        }
                        
                        this.expenses = [];
                        this.payments = [];
                        this.renderExpenses();
                        alert('All data has been reset successfully.');
                    } catch (error) {
                        alert('Failed to reset: ' + error.message);
                    }
                },
                
                exportToJSON: function() {
                    const data = { expenses: this.expenses, payments: this.payments, people: this.people };
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `japan2025-expenses-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    alert('‚úì Data exported!');
                },
                
                exportToCSV: function() {
                    if (this.expenses.length === 0) {
                        alert('No expenses to export');
                        return;
                    }
                    
                    let csv = 'Date,Description,Category,Amount (PHP),Paid By,Split Between,Per Person (PHP)\n';
                    this.expenses.forEach(exp => {
                        const perPerson = exp.amount / exp.splitBetween.length;
                        csv += `${exp.date},"${exp.description}",${exp.category},${exp.amount},${exp.paidBy},"${exp.splitBetween.join(', ')}",${perPerson.toFixed(2)}\n`;
                    });
                    
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `japan2025-expenses-${new Date().toISOString().split('T')[0]}.csv`;
                    a.click();
                },
                
                copyToClipboard: function() {
                    const totalSpent = this.expenses.reduce((sum, exp) => sum + exp.amount, 0);
                    let text = `üáØüáµ JAPAN 2025 EXPENSES SUMMARY\n\n`;
                    text += `Total Spent: ‚Ç±${totalSpent.toFixed(2)}\n`;
                    text += `Per Person Average: ‚Ç±${(totalSpent / 7).toFixed(2)}\n\n`;
                    
                    text += `INDIVIDUAL BALANCES:\n`;
                    const balances = {};
                    this.people.forEach(person => {
                        balances[person] = { paid: 0, owes: 0 };
                    });
                    
                    this.expenses.forEach(exp => {
                        balances[exp.paidBy].paid += exp.amount;
                        const perPerson = exp.amount / exp.splitBetween.length;
                        exp.splitBetween.forEach(person => {
                            balances[person].owes += perPerson;
                        });
                    });
                    
                    this.people.forEach(person => {
                        const net = balances[person].paid - balances[person].owes;
                        text += `${person}: ${net >= 0 ? 'Gets back' : 'Owes'} ‚Ç±${Math.abs(net).toFixed(2)}\n`;
                    });
                    
                    text += `\nSETTLEMENT PLAN:\n`;
                    
                    const debtors = [];
                    const creditors = [];
                    
                    Object.entries(balances).forEach(([person, balance]) => {
                        const net = balance.paid - balance.owes;
                        if (net < -0.01) {
                            debtors.push({ person, amount: -net });
                        } else if (net > 0.01) {
                            creditors.push({ person, amount: net });
                        }
                    });
                    
                    let i = 0, j = 0;
                    while (i < debtors.length && j < creditors.length) {
                        const amount = Math.min(debtors[i].amount, creditors[j].amount);
                        const settlementId = `${debtors[i].person}-${creditors[j].person}`;
                        const isPaid = this.payments.includes(settlementId);
                        text += `${debtors[i].person} ‚Üí ${creditors[j].person}: ‚Ç±${amount.toFixed(2)} ${isPaid ? '‚úì PAID' : '‚è≥ PENDING'}\n`;
                        
                        debtors[i].amount -= amount;
                        creditors[j].amount -= amount;
                        
                        if (debtors[i].amount < 0.01) i++;
                        if (creditors[j].amount < 0.01) j++;
                    }
                    
                    navigator.clipboard.writeText(text).then(() => {
                        alert('‚úì Summary copied to clipboard!');
                    }).catch(() => {
                        alert('Failed to copy to clipboard');
                    });
                }
            };
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => app.init());
            } else {
                app.init();
            }
        })();
    </script>
</body>
</html>